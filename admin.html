<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Create Project</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 2em;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 700px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="text"] {
            display: block;
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            padding: 12px 0;
            margin-bottom: 15px;
            border: 2px dashed #007bff;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            color: #007bff;
            font-weight: 600;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .main-button {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: 4px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        .main-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #image-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .upload-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .upload-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .upload-status {
            padding: 8px;
            font-size: 12px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .progress-bar {
            width: 0%;
            height: 4px;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .status-text {
            font-weight: 500;
        }
        .status-text.success { color: #28a745; }
        .status-text.error { color: #dc3545; }

    </style>
</head>
<body>
    <div class="container">
        <h1>Create a New Project</h1>
        <div class="form-group">
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" placeholder="Enter the project's name">
        </div>
        <div class="form-group">
            <label>Upload Images</label>
            <div class="file-input-wrapper">
                <span>Click to Select Images</span>
                <input type="file" id="imageUpload" multiple accept="image/*">
            </div>
        </div>
        <div id="image-previews"></div>
        <div class="form-group">
            <label for="driveLink">Google Drive Link</label>
            <input type="text" id="driveLink" placeholder="https://drive.google.com/...">
        </div>
        <button id="createProjectBtn" class="main-button" onclick="createProject()">Create Project</button>
    </div>

    <!-- Use the latest compatible Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-u3L7Jz3gEfXmfP7-XQfPnI2CwpJM_Vs",
            authDomain: "harsha-demo01.firebaseapp.com",
            projectId: "harsha-demo01",
            storageBucket: "harsha-demo01.firebasestorage.app",
            messagingSenderId: "676891713475",
            appId: "1:676891713475:web:a57e93657253e27a382776",
            measurementId: "G-B211571YB4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const imageUpload = document.getElementById('imageUpload');
        const imagePreviews = document.getElementById('image-previews');
        const createProjectBtn = document.getElementById('createProjectBtn');

        let uploadedImageUrls = [];
        let totalFiles = 0;
        let successfulUploads = 0;

        auth.signInAnonymously().catch(error => {
            console.error("Anonymous sign-in failed: ", error);
            alert(`Authentication Failed: ${error.message}`);
        });

        imageUpload.addEventListener('change', handleImageSelection);

        function handleImageSelection(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            imagePreviews.innerHTML = '';
            uploadedImageUrls = [];
            totalFiles = files.length;
            successfulUploads = 0;
            createProjectBtn.disabled = true;
            createProjectBtn.textContent = 'Waiting for uploads to finish...';

            [...files].forEach((file, index) => uploadFile(file, index));
        }

        function uploadFile(file, index) {
            const previewId = `preview-${index}`;
            const cardHTML = `
                <div class="upload-card" id="${previewId}">
                    <img src="${URL.createObjectURL(file)}" alt="Image preview">
                    <div class="upload-status">
                        <div class="status-text">Uploading... 0%</div>
                        <div class="progress-bar"></div>
                    </div>
                </div>
            `;
            imagePreviews.insertAdjacentHTML('beforeend', cardHTML);

            const card = document.getElementById(previewId);
            const progressBar = card.querySelector('.progress-bar');
            const statusText = card.querySelector('.status-text');

            const uniqueFileName = `${Date.now()}-${file.name}`;
            const storageRef = storage.ref(`images/${uniqueFileName}`);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `Uploading... ${Math.round(progress)}%`;
                },
                (error) => {
                    console.error("Upload failed for file: ", file.name, error);
                    statusText.textContent = 'Upload Failed';
                    statusText.classList.add('error');
                    totalFiles--; 
                    checkAllUploadsComplete(); 
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        uploadedImageUrls.push({ index, url: downloadURL }); 
                        successfulUploads++;
                        statusText.textContent = 'Complete!';
                        statusText.classList.add('success');
                        checkAllUploadsComplete();
                    });
                }
            );
        }
        
        function checkAllUploadsComplete() {
            if (successfulUploads === totalFiles && totalFiles > 0) {
                createProjectBtn.disabled = false;
                createProjectBtn.textContent = 'Create Project';
            }
        }

        async function createProject() {
            const projectName = document.getElementById('projectName').value.trim();
            const driveLink = document.getElementById('driveLink').value.trim();

            if (!projectName || !driveLink) {
                alert('Please provide a project name and a Drive link.');
                return;
            }

            if (uploadedImageUrls.length === 0 || successfulUploads < totalFiles) {
                alert('Please wait for all images to upload successfully before saving.');
                return;
            }

            createProjectBtn.disabled = true;
            createProjectBtn.textContent = 'Saving...';

            try {
                const sortedUrls = uploadedImageUrls.sort((a, b) => a.index - b.index).map(item => item.url);

                await db.collection('projects').add({
                    name: projectName,
                    images: sortedUrls,
                    driveLink: driveLink,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Project created successfully!');
                
                document.getElementById('projectName').value = '';
                document.getElementById('driveLink').value = '';
                imageUpload.value = '';
                imagePreviews.innerHTML = '';
                uploadedImageUrls = [];
                totalFiles = 0;
                successfulUploads = 0;

            } catch (error) {
                console.error("FIRESTORE SAVE FAILED: ", error);
                alert(`Error: Could not save the project to the database.\n\nREASON: ${error.message}`);
            
            } finally {
                createProjectBtn.disabled = false;
                createProjectBtn.textContent = 'Create Project';
            }
        }
    </script>
</body>
</html>
